<html>
<head>
  <script src="Chart.min.js"></script>
</head>
<body>
  <div style="width:75%;">
    <canvas id="graph"></canvas>
  </div>
  <script>
    var chart;
    var numSamples = 0;
    var MAX_NUM_SAMPLES = 120; // <- 1 minute
    var ws = new WebSocket('ws://' + location.host + '/ws');
    ws.binaryType = "arraybuffer";
    ws.onmessage = function (event) {
      var view = new DataView(event.data);
      var glcontext = view.getInt32(0);
      var frame = view.getInt32(4);
      var frameTimeCpuMs = view.getFloat32(8);
      var drawCallTimeGpuMs = view.getFloat32(12);
      var glCalls = view.getInt32(16);
      var vertices = view.getInt32(20);
      var bufferObjectSize = view.getFloat64(24);
      var textureObjectSize = view.getFloat64(32);
      numSamples++;
      if (numSamples > MAX_NUM_SAMPLES) {
        config.data.labels.shift();
        config.data.datasets[0].data.shift();
        config.data.datasets[1].data.shift();
        config.data.datasets[2].data.shift();
        config.data.datasets[3].data.shift();
        config.data.datasets[4].data.shift();
        config.data.datasets[5].data.shift();
      }
      config.data.labels.push(frame);
      config.data.datasets[0].data.push(frameTimeCpuMs);
      config.data.datasets[1].data.push(drawCallTimeGpuMs);
      config.data.datasets[2].data.push(glCalls);
      config.data.datasets[3].data.push(vertices);
      config.data.datasets[4].data.push(bufferObjectSize);
      config.data.datasets[5].data.push(textureObjectSize);
      chart.update();
    }
    var config = {
      data: {
        labels: [
        ],
        datasets: [{
          type: 'line',
          label: "Frame CPU (ms.)",
          fill: false,
          borderColor: "rgba(220,0,0,0.8)",
          yAxisID: "time",
          data: []
        }, {
          type: 'line',
          label: "Draw GPU (ms.)",
          fill: false,
          borderColor: "rgba(190,120,40,0.8)",
          yAxisID: "time",
          data: []
        }, {
          type: 'line',
          label: "GL calls",
          fill: false,
          borderColor: "rgba(20,20,220,0.8)",
          yAxisID: "glcalls",
          data: []
        }, {
          type: 'line',
          label: "Vertices",
          fill: false,
          borderColor: "rgba(20,220,220,0.8)",
          yAxisID: "vertices",
          data: []
        }, {
          type: 'line',
          label: "BO memory (kilobytes)",
          fill: true,
          borderColor: "rgba(220,20,220,0.8)",
          backgroundColor: "rgba(220,20,220,0.05)",
          yAxisID: "bo_memory",
          data: []
        }, {
          type: 'line',
          label: "TO memory (kilobytes)",
          fill: true,
          borderColor: "rgba(220,220,20,0.8)",
          backgroundColor: "rgba(220,220,20,0.05)",
          yAxisID: "to_memory",
          data: []
        }]
      },
      options: {
        animation: false,
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: "frames"
            }
          }],
          yAxes: [{
            position: "left",
            id: "time",
            ticks: {
              fontColor: "#A22",
              beginAtZero: true
            }
          }, {
            position: "right",
            id: "glcalls",
            ticks: {
              fontColor: "#22A",
              beginAtZero: true,
              callback: function (value, index, values) {
                return value.toLocaleString();
              }
            }
          }, {
            position: "right",
            id: "vertices",
            ticks: {
              fontColor: "#2AA",
              beginAtZero: true,
              callback: function (value, index, values) {
                return value.toLocaleString();
              }
            }
          }, {
            position: "right",
            id: "bo_memory",
            ticks: {
              fontColor: "#A2A",
              beginAtZero: true,
              callback: function (value, index, values) {
                return value.toLocaleString();
              }
            }
          }, {
            position: "right",
            id: "to_memory",
            ticks: {
              fontColor: "#AA2",
              beginAtZero: true,
              callback: function (value, index, values) {
                return value.toLocaleString();
              }
            }
          }]
        }
      }
    };
    window.onload = function () {
      var ctx = document.getElementById("graph").getContext("2d");
      chart = new Chart(ctx, config);
    };
  </script>
</body>
</html>
